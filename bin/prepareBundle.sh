#! /bin/bash

# This script prepares a "bundle" for a project, given the specified target folder as the first argument.
# This will remove gpg file (*.asc) generated by the maven-gpg-plugin as from time to time these files
# are corrupted.  This will use the gpg command directly to produce the files then use gpg to verify them.

targetFolder=$1

pushd $targetFolder

rm -f *.asc

bundleJarName=`ls | grep pom | perl -pi -e 's/\.pom//'`-bundle.jar

if [ "" == "$GPGPASSPHRASE" ]; then
	echo "Environment variable GPGPASSPHRASE must be defined"
	exit 1
fi

for f in *.jar *.pom
do
	gpg -ab --passphrase $GPGPASSPHRASE $f
done

for f in *.asc
do 
	gpg --verify $f
	if [ "$?" != "0" ]; then
		echo "Signature couldn't be verified."
		exit 1
	fi    
done

jar -cvf $bundleJarName *.jar *.pom *.asc 

popd
